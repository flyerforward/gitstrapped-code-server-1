worker_processes  1;
events { worker_connections  1024; }

http {
  # minimal TLS for demo; replace with real certs or front with TLS proxy
  server {
    listen 443 ssl;
    server_name _;

    # Self-signed for demo only; replace in prod
    ssl_certificate     /etc/ssl/certs/ssl-cert-snakeoil.pem;
    ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;

    # ---- auth_request location (subrequest to oauth2-proxy) ----
    location = /oauth2/auth {
      proxy_pass       http://oauth2-proxy:4180/oauth2/auth;
      proxy_set_header X-Original-URI    $request_uri;
      proxy_set_header X-Original-Method $request_method;
      proxy_set_header Content-Length    "";
      proxy_pass_request_body off;
    }

    # Capture headers set by oauth2-proxy for the main requests
    set $auth_user        "";
    set $auth_email       "";
    set $auth_access_token "";

    # ---- Bootstrap endpoint ----
    location /bootstrap {
      auth_request /oauth2/auth;

      auth_request_set $auth_user         $upstream_http_x_auth_request_user;
      auth_request_set $auth_email        $upstream_http_x_auth_request_email;
      auth_request_set $auth_access_token $upstream_http_x_auth_request_access_token;

      proxy_set_header X-Auth-Request-User          $auth_user;
      proxy_set_header X-Auth-Request-Email         $auth_email;
      proxy_set_header X-Auth-Request-Access-Token  $auth_access_token;

      proxy_pass http://bootstrap:8080;
    }

    # ---- code-server (everything else) ----
    location / {
      auth_request /oauth2/auth;

      auth_request_set $auth_user         $upstream_http_x_auth_request_user;
      auth_request_set $auth_access_token $upstream_http_x_auth_request_access_token;

      # Forward identity headers in case extensions want to read them
      proxy_set_header X-Auth-Request-User          $auth_user;
      proxy_set_header X-Auth-Request-Access-Token  $auth_access_token;

      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;

      proxy_pass http://code:8443;
    }

    # ---- oauth2-proxy endpoints for login/logout/callback ----
    location /oauth2/ {
      proxy_pass http://oauth2-proxy:4180;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Scheme $scheme;
    }
  }
}
